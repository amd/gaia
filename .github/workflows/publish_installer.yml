# Copyright(C) 2025-2026 Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

name: Publish GAIA Release

on:
  push:
    tags:
      - v*
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-electron-apps:
    uses: ./.github/workflows/build-electron-apps.yml

  publish-release:
    runs-on: ubuntu-latest
    needs: [build-electron-apps]
    if: always() && (needs.build-electron-apps.result == 'success' || needs.build-electron-apps.result == 'skipped')
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history for release notes generation

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Get the previous tag
          previous_tag=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$previous_tag" ]; then
            # If previous tag exists, generate changelog from previous tag to current
            changelog=$(git log --pretty=format:"* %s (%h)" "$previous_tag"..HEAD)
          else
            # If no previous tag, get all commits
            changelog=$(git log --pretty=format:"* %s (%h)")
          fi
          # Save to output
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download Electron App Artifacts (Windows)
        if: needs.build-electron-apps.outputs.has_apps == 'true'
        uses: actions/download-artifact@v7
        with:
          pattern: "*-windows-${{ github.sha }}"
          path: release-assets
          merge-multiple: true
        continue-on-error: true

      - name: Download Electron App Artifacts (Linux)
        if: needs.build-electron-apps.outputs.has_apps == 'true'
        uses: actions/download-artifact@v7
        with:
          pattern: "*-linux-${{ github.sha }}"
          path: release-assets
          merge-multiple: true
        continue-on-error: true

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          body: |
            ## What's Changed
            ${{ steps.release_notes.outputs.CHANGELOG }}

            ## Installation
            Install GAIA using pip:
            ```bash
            pip install amd-gaia
            ```

            Or using uv:
            ```bash
            uv pip install amd-gaia
            ```
