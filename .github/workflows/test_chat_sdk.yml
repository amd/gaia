# Copyright(C) 2025-2026 Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

# This workflow tests the Chat SDK functionality with Lemonade server integration
# Tests include: Chat SDK API, conversation handling, and Lemonade integration
# Platform: Windows (with Lemonade server support)

name: Chat SDK Tests (Windows)

on:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "tests/**"
      - "setup.py"
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "src/**"
      - "tests/**"
      - "setup.py"
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-chat-sdk-windows:
    name: Test Chat SDK on Windows (Lemonade Integration)
    runs-on: [stx]
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python Environment
        uses: ./.github/actions/setup-venv
        with:
          python-version: '3.12'
          install-package: '.[dev,lemonade]'

      - name: Start Lemonade Server and Run Chat SDK Tests
        shell: cmd
        timeout-minutes: 15
        env:
          HUGGINGFACE_ACCESS_TOKEN: ${{ secrets.HUGGINGFACE_ACCESS_TOKEN }}
          HF_TOKEN: ${{ secrets.HUGGINGFACE_ACCESS_TOKEN }}
          PYTHONIOENCODING: utf-8
        run: |
          call scripts\start-lemonade.bat Qwen3-4B-Instruct-2507-GGUF 8000 8192
          if %ERRORLEVEL% neq 0 exit /b 1

          call "%GITHUB_WORKSPACE%\.venv\Scripts\activate.bat"
          echo === Chat SDK Integration Tests ===
          python tests\test_chat_sdk.py
          if %ERRORLEVEL% neq 0 (
              echo.
              echo --- Lemonade Server Logs ---
              if exist "lemonade-server.log" type lemonade-server.log
              exit /b 1
          )
          echo [OK] Chat SDK tests passed

      - name: Debug Logs on Failure
        if: failure()
        shell: cmd
        run: |
          echo === Debug Info ===
          echo.
          echo --- Lemonade Server Logs ---
          if exist "lemonade-server.log" type lemonade-server.log
          echo.
          echo --- GAIA Logs ---
          if exist "gaia.cli.log" type gaia.cli.log
          echo.
          echo --- Processes ---
          tasklist | findstr /i "python gaia lemonade"
          echo.
          echo --- Ports ---
          netstat -an | findstr ":8000 :8001"