# Copyright(C) 2025-2026 Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

name: Lemonade Server Smoke Test

on:
  workflow_call:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-lemonade-server:
    name: Lemonade Server Smoke Test
    runs-on: [stx]
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

    steps:
      - uses: actions/checkout@v6

      - name: Kill Stuck Installer Processes
        if: always()
        continue-on-error: true
        run: |
          Write-Host "Cleaning up any stuck MSI installer processes..."
          try {
              # Kill msiexec processes (MSI installer)
              Get-Process msiexec -ErrorAction SilentlyContinue | Stop-Process -Force
              Write-Host "Killed stuck msiexec processes"
          } catch {
              Write-Host "No stuck msiexec processes found"
          }

      - name: Setup Python environment
        uses: ./.github/actions/setup-venv
        with:
          python-version: '3.12'
          install-package: '.[lemonade]'

      - name: Initialize Lemonade with Minimal Profile
        shell: cmd
        timeout-minutes: 10
        env:
          HUGGINGFACE_ACCESS_TOKEN: ${{ secrets.HUGGINGFACE_ACCESS_TOKEN }}
          HF_TOKEN: ${{ secrets.HUGGINGFACE_ACCESS_TOKEN }}
        run: |
          call "%GITHUB_WORKSPACE%\.venv\Scripts\activate.bat"

          echo ================================================================
          echo      Lemonade Smoke Test via gaia init --profile minimal
          echo ================================================================
          echo This validates:
          echo   1. Lemonade Server installation and startup
          echo   2. Model download (Qwen3-4B-Instruct-2507-GGUF - cached if available)
          echo   3. Health endpoint
          echo   4. Basic LLM inference
          echo.

          REM Use --yes to auto-confirm, --skip-lemonade since already installed
          gaia init --profile minimal --yes --skip-lemonade

          echo.
          echo ================================================================
          echo      Lemonade Smoke Test Complete
          echo ================================================================

      - name: Cleanup
        if: always()
        run: |
          Write-Host "Stopping Lemonade Server..."
          try {
              Stop-Process -Name "lemonade-server" -Force -ErrorAction SilentlyContinue
              Write-Host "Server stopped"
          } catch {
              Write-Host "Server already stopped or not running"
          }
