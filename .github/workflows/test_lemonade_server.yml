# Copyright(C) 2025-2026 Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

name: Lemonade Server Smoke Test

on:
  workflow_call:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-lemonade-server:
    name: Lemonade Server Smoke Test
    runs-on: [stx]
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

    steps:
      - uses: actions/checkout@v6

      - name: Kill Stuck Processes (MSI and Lemonade Server)
        if: always()
        continue-on-error: true
        run: |
          Write-Host "Cleaning up any stuck processes that block MSI install..."

          # Kill stuck msiexec processes
          $msiProcesses = Get-Process msiexec -ErrorAction SilentlyContinue
          if ($msiProcesses) {
              $msiProcesses | Stop-Process -Force
              Write-Host "Killed $($msiProcesses.Count) stuck msiexec process(es)"
          }

          # Kill any running lemonade-server processes (prevents StopLegacyPythonServer hang)
          $lemonadeProcesses = Get-Process lemonade-server -ErrorAction SilentlyContinue
          if ($lemonadeProcesses) {
              $lemonadeProcesses | Stop-Process -Force
              Write-Host "Killed $($lemonadeProcesses.Count) lemonade-server process(es)"
          }

          # Wait for cleanup
          if ($msiProcesses -or $lemonadeProcesses) {
              Write-Host "Waiting 5 seconds for cleanup to complete..."
              Start-Sleep -Seconds 5
          }

          Write-Host "Cleanup complete - ready for fresh install"

      - name: Setup Python environment
        uses: ./.github/actions/setup-venv
        with:
          python-version: '3.12'
          install-package: '.[lemonade]'

      - name: Install Lemonade Server
        uses: ./.github/actions/install-lemonade

      - name: Initialize Lemonade with Minimal Profile
        shell: cmd
        timeout-minutes: 10
        env:
          HUGGINGFACE_ACCESS_TOKEN: ${{ secrets.HUGGINGFACE_ACCESS_TOKEN }}
          HF_TOKEN: ${{ secrets.HUGGINGFACE_ACCESS_TOKEN }}
        run: |
          call "%GITHUB_WORKSPACE%\.venv\Scripts\activate.bat"

          echo ================================================================
          echo      Lemonade Smoke Test via gaia init --profile minimal
          echo ================================================================
          echo This validates:
          echo   1. Lemonade Server startup (using existing version)
          echo   2. Model download (Qwen3-4B-Instruct-2507-GGUF - cached if available)
          echo   3. Health endpoint
          echo   4. Basic LLM inference
          echo.
          echo Note: Using --skip-lemonade to avoid MSI upgrade (works with v9.0.4+)
          echo.

          REM Use --skip-lemonade to avoid MSI hang, --yes for auto-confirm
          gaia init --profile minimal --yes --skip-lemonade --verbose

          echo.
          echo ================================================================
          echo      Lemonade Smoke Test Complete
          echo ================================================================

      - name: Cleanup
        if: always()
        run: |
          Write-Host "Stopping Lemonade Server..."
          try {
              Stop-Process -Name "lemonade-server" -Force -ErrorAction SilentlyContinue
              Write-Host "Server stopped"
          } catch {
              Write-Host "Server already stopped or not running"
          }
