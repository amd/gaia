# Copyright(C) 2025-2026 Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

name: Test RAG

on:
  workflow_call:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, ready_for_review]
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-rag-unit:
    name: RAG Unit Tests
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

    steps:
    - uses: actions/checkout@v6

    - name: Free disk space
      uses: ./.github/actions/free-disk-space

    - name: Setup Python environment
      uses: ./.github/actions/setup-venv
      with:
        python-version: '3.12'
        install-package: '.[dev,rag]'
        extra-index-url: 'https://download.pytorch.org/whl/cpu'

    - name: Install additional test dependencies
      run: |
        uv pip install pytest-cov --python .venv/bin/python

    - name: Run RAG unit tests
      run: |
        echo "Running RAG unit tests..."
        pytest tests/test_rag.py -v -s --tb=short --cov=src/gaia/rag --cov-report=term-missing

    - name: Upload coverage report
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: rag-unit-test-coverage
        path: .coverage

  test-rag-integration:
    name: RAG Integration Tests
    runs-on: [stx]
    needs: test-rag-unit
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

    steps:
    - uses: actions/checkout@v6

    - name: Setup Python environment
      uses: ./.github/actions/setup-venv
      with:
        python-version: '3.12'
        install-package: '.[dev,rag,lemonade]'
        extra-index-url: 'https://download.pytorch.org/whl/cpu'

    - name: Install additional test dependencies
      shell: powershell
      run: |
        uv pip install reportlab --python .venv\Scripts\python.exe

    - name: Start Lemonade Server and Load Models
      id: start-lemonade
      uses: ./.github/actions/start-lemonade
      with:
        model-name: 'nomic-embed-text-v2-moe-GGUF'
        additional-models: 'Qwen3-0.6B-GGUF,Qwen2.5-VL-7B-Instruct-GGUF'
        ctx-size: '8192'
        clear-cache: 'true'
        init-wait-time: '30'

    - name: Run RAG Integration Tests
      shell: powershell
      run: |
        # Set console to UTF-8 for Unicode support
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::InputEncoding = [System.Text.Encoding]::UTF8
        $OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"
        $env:PYTHONUTF8 = "1"
        chcp 65001 | Out-Null

        try {
            # Store Lemonade process ID for cleanup
            $env:LEMONADE_PROCESS_ID = "${{ steps.start-lemonade.outputs.server-process-id }}"

            # Verify models
            try {
                $models = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/models" -Method GET
                Write-Host "`n[OK] Available models:"
                $models.data | ForEach-Object { Write-Host "   - $($_.id)" }
            } catch {
                Write-Host "[WARN] Could not list models: $($_.Exception.Message)"
            }

            # Verify server is still responding before embeddings test
            Write-Host "`n=== Verifying Server Health ==="
            try {
                $health = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/health" -Method GET -TimeoutSec 10
                Write-Host "[OK] Server responding: $($health | ConvertTo-Json -Compress)"
            } catch {
                Write-Host "[ERROR] Server health check failed: $($_.Exception.Message)"
                # Show server job output for debugging
                if ($env:LEMONADE_JOB_ID) {
                    $jobOutput = Receive-Job -Id $env:LEMONADE_JOB_ID -ErrorAction SilentlyContinue
                    Write-Host "Server output: $jobOutput"
                }
                throw "Server not responding after model load"
            }

            # Verify embedding model with actual API call
            Write-Host "`n=== Verifying Embedding Model ==="
            $maxRetries = 3
            $retryCount = 0
            $modelReady = $false

            while ($retryCount -lt $maxRetries -and -not $modelReady) {
                try {
                    $testBody = @{ input = @("test embedding"); model = "nomic-embed-text-v2-moe-GGUF" } | ConvertTo-Json
                    # Use localhost consistently and increased timeout for first embedding request
                    $response = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/embeddings" `
                        -Method POST -ContentType "application/json" -Body $testBody -TimeoutSec 300
                    Write-Host "[OK] Embedding model verified successfully"
                    $modelReady = $true
                } catch {
                    $retryCount++
                    Write-Host "[WARN] Embedding verification attempt $retryCount failed: $($_.Exception.Message)"
                    if ($retryCount -lt $maxRetries) {
                        Write-Host "Waiting 30 seconds before retry..."
                        Start-Sleep -Seconds 30
                    }
                }
            }

            if (-not $modelReady) {
                throw "Embedding model failed to load after $maxRetries attempts"
            }

            # Run tests in same session while server is running
            Write-Host "`n=== Running RAG Integration Tests ==="
            python tests/test_rag_integration.py
            $testExitCode = $LASTEXITCODE

            Write-Host "`nTests completed with exit code: $testExitCode"

            if ($testExitCode -ne 0) {
                throw "Tests failed with exit code $testExitCode"
            }
        } finally {
            # Always cleanup server
            if ($env:LEMONADE_PROCESS_ID) {
                Write-Host "`n=== Stopping Lemonade Server ==="
                try {
                    Stop-Process -Id $env:LEMONADE_PROCESS_ID -Force -ErrorAction SilentlyContinue
                    Write-Host "[OK] Server stopped"
                } catch {
                    Write-Host "[WARN] Could not stop Lemonade server: $_"
                }
            }
        }

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: rag-integration-test-results
        path: |
          pytest-results/
          *.log
