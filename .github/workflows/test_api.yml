# Copyright(C) 2025-2026 Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

# This workflow tests the GAIA OpenAI-compatible API server functionality
# Tests include: Chat completions, streaming SSE, model listing, error handling

name: API Server Tests

on:
  workflow_call:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened, ready_for_review]
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-api:
    name: API Tests
    runs-on: [stx]
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')

    steps:
      - uses: actions/checkout@v6

      - name: Setup Python environment
        uses: ./.github/actions/setup-venv
        with:
          python-version: '3.12'
          install-package: '.[dev,api,lemonade]'

      - name: Install additional test dependencies
        shell: powershell
        run: |
          uv pip install pytest pytest-timeout requests --python .venv\Scripts\python.exe

      - name: Start Lemonade Server and Load Model
        id: start-lemonade
        uses: ./.github/actions/start-lemonade
        with:
          model-name: 'Qwen3-0.6B-GGUF'
          ctx-size: '8192'

      - name: Start GAIA API Server and Run Tests
        shell: powershell
        run: |
          # Set console to UTF-8 for Unicode support
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.Encoding]::UTF8
          $OutputEncoding = [System.Text.Encoding]::UTF8
          $env:PYTHONIOENCODING = "utf-8"
          $env:PYTHONUTF8 = "1"
          chcp 65001 | Out-Null

          try {
              # Store Lemonade process ID for cleanup
              $env:LEMONADE_PROCESS_ID = "${{ steps.start-lemonade.outputs.server-process-id }}"

              # Start API server using gaia CLI (runs on default port 8080)
              Write-Host "`n=== Starting GAIA API Server ==="
              $apiJob = Start-Job -ScriptBlock {
                  Set-Location $using:PWD
                  & .\.venv\Scripts\Activate.ps1
                  $env:AGENT_ROUTING_MODEL = "Qwen3-0.6B-GGUF"
                  & gaia api start 2>&1
              }
              Write-Host "Started API server job with ID: $($apiJob.Id)"
              $env:API_JOB_ID = $apiJob.Id

              # Wait for API server to start
              Write-Host "Waiting for API server to start..."
              $maxWaitTime = 30
              $waitTime = 0
              $apiReady = $false

              while ($waitTime -lt $maxWaitTime -and -not $apiReady) {
                  Start-Sleep -Seconds 2
                  $waitTime += 2

                  try {
                      $response = Invoke-RestMethod -Uri "http://localhost:8080/health" -Method GET -TimeoutSec 5
                      Write-Host "[OK] API server is running and healthy"
                      $apiReady = $true
                  } catch {
                      Write-Host "Waiting for API server... ($waitTime/$maxWaitTime seconds)"
                  }
              }

              if (-not $apiReady) {
                  Write-Host "[ERROR] API server failed to start after $maxWaitTime seconds"
                  throw "API server failed to start"
              }

              # Run tests in same session while servers are running
              Write-Host "`n=== Running API Integration Tests ==="
              $env:CI = "true"
              uv run pytest tests/test_api.py -v --tb=short --capture=no
              $testExitCode = $LASTEXITCODE

              Write-Host "`nTests completed with exit code: $testExitCode"

              if ($testExitCode -ne 0) {
                  throw "Tests failed with exit code $testExitCode"
              }
          } finally {
              # Always cleanup servers
              Write-Host "`n=== Stopping Servers ==="
              if ($env:API_JOB_ID) {
                  Write-Host "Stopping API server..."
                  Stop-Job -Id $env:API_JOB_ID -ErrorAction SilentlyContinue
                  Remove-Job -Id $env:API_JOB_ID -ErrorAction SilentlyContinue
                  Write-Host "[OK] API server stopped"
              }
              if ($env:LEMONADE_PROCESS_ID) {
                  Write-Host "Stopping Lemonade server..."
                  try {
                      Stop-Process -Id $env:LEMONADE_PROCESS_ID -Force -ErrorAction SilentlyContinue
                      Write-Host "[OK] Lemonade server stopped"
                  } catch {
                      Write-Host "[WARN] Could not stop Lemonade server: $_"
                  }
              }
          }

      - name: Upload API Server Logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: api-server-logs
          path: |
            gaia.api.log
            gaia_api.log
            *.log
