# Copyright(C) 2025-2026 Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

# This workflow tests the GAIA CLI on Windows with full Lemonade server integration
# Tests include: CLI functionality, Lemonade integration, audio features, and core commands
# Platform: Windows (with Lemonade server and NPU support)

name: GAIA CLI Tests (Windows)

on:
  workflow_call:
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "tests/**"
      - "setup.py"
      - "pyproject.toml"
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "src/**"
      - "tests/**"
      - "setup.py"
      - "pyproject.toml"
  merge_group:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-gaia-cli-windows:
    name: Test GAIA CLI on Windows (Full Integration)
    runs-on: [stx]
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false || contains(github.event.pull_request.labels.*.name, 'ready_for_ci')
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python Environment
        uses: ./.github/actions/setup-venv
        with:
          python-version: '3.12'
          # Note: 'blender' excluded as bpy requires Blender runtime
          install-package: '.[dev,talk,rag,mcp,api,lemonade]'

      - name: Verify GAIA Installation
        run: |
          Write-Host "Verifying GAIA installation..."
          $gaiaPath = Get-Command gaia -ErrorAction SilentlyContinue
          if (-not $gaiaPath) {
            Write-Host "Error: gaia not installed correctly"
            Write-Host "Current PATH: $env:Path"
            exit 1
          }
          Write-Host "Found gaia at: $($gaiaPath.Source)"
          python --version
          python -m pip check

      - uses: FedericoCarboni/setup-ffmpeg@v3
        id: setup-ffmpeg

      - name: Start Lemonade Server and Run All Integration Tests
        shell: powershell
        timeout-minutes: 30
        env:
          HUGGINGFACE_ACCESS_TOKEN: ${{ secrets.HUGGINGFACE_ACCESS_TOKEN }}
          HF_TOKEN: ${{ secrets.HUGGINGFACE_ACCESS_TOKEN }}
          PYTHONUTF8: 1
          GAIA_TEST_MODEL: Qwen3-4B-Instruct-2507-GGUF
        run: |
          # UTF-8 setup
          chcp 65001 | Out-Null
          $env:PYTHONIOENCODING = "utf-8"

          # Start Lemonade server
          .\scripts\start-lemonade.ps1 `
            -ModelName "Qwen3-4B-Instruct-2507-GGUF" `
            -CtxSize 8192 `
            -InitWaitTime 10

          # Track test results
          $testResults = @{
            "test_llm" = 0
            "test_asr" = 0
            "test_tts" = 0
            "test_summarizer" = 0
            "test_lemonade" = 0
          }

          Write-Host "`n=== Running Unit Tests ==="

          Write-Host "--- test_llm.py ---"
          python tests/unit/test_llm.py
          $testResults["test_llm"] = $LASTEXITCODE

          Write-Host "--- test_asr.py ---"
          python tests/unit/test_asr.py
          $testResults["test_asr"] = $LASTEXITCODE

          Write-Host "--- test_tts.py ---"
          python tests/unit/test_tts.py
          $testResults["test_tts"] = $LASTEXITCODE

          Write-Host "`n=== Running Summarizer CLI Tests ==="
          pytest tests/test_summarizer.py -vs --tb=short
          $testResults["test_summarizer"] = $LASTEXITCODE

          Write-Host "`n=== Running Lemonade Client Integration Tests ==="
          pytest tests/test_lemonade_client.py -vs --tb=short -k "Integration"
          $testResults["test_lemonade"] = $LASTEXITCODE

          Write-Host "`n=== Test Summary ==="
          $testResults.GetEnumerator() | ForEach-Object {
            Write-Host "$($_.Key): $($_.Value)"
          }

          $totalFailures = ($testResults.Values | Measure-Object -Sum).Sum
          if ($totalFailures -eq 0) {
            Write-Host "[OK] All tests passed"
            exit 0
          } else {
            Write-Host "[FAIL] Some tests failed"
            exit 1
          }

      - name: Debug Logs on Failure
        if: failure()
        shell: powershell
        run: |
          Write-Host "=== Debug Info ==="
          Write-Host ""
          Write-Host "--- Lemonade Server Logs ---"
          if (Test-Path "lemonade-server-stdout.log") { Get-Content "lemonade-server-stdout.log" -Tail 100 }
          if (Test-Path "lemonade-server-stderr.log") { Get-Content "lemonade-server-stderr.log" -Tail 50 }
          if (Test-Path "lemonade-server.log") { Get-Content "lemonade-server.log" -Tail 100 }
          Write-Host ""
          Write-Host "--- GAIA Logs ---"
          if (Test-Path "gaia.cli.log") { Get-Content "gaia.cli.log" -Tail 100 }
          Write-Host ""
          Write-Host "--- Processes ---"
          Get-Process | Where-Object { $_.Name -match "python|gaia|lemonade" } | Format-Table
          Write-Host ""
          Write-Host "--- Ports ---"
          netstat -an | Select-String ":8000|:8001"