# Copyright(C) 2024 Advanced Micro Devices, Inc. All rights reserved.

# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: GAIA UI Test

on:
  push:
    branches: ["main"]
    paths-ignore:
      - 'docs/**'
      - 'data/**'
      - 'notebooks/**'
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened, ready_for_review]
    paths-ignore:
      - 'docs/**'
      - 'data/**'
      - 'notebooks/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  gaia-ui-test:
    runs-on: windows-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v3

      - name: Download and Install Miniconda
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://repo.anaconda.com/miniconda/Miniconda3-latest-Windows-x86_64.exe" -OutFile "miniconda.exe"
          Start-Process -FilePath "miniconda.exe" -ArgumentList "/S", "/D=$env:USERPROFILE\Miniconda3" -Wait

      - name: Initialize Conda
        shell: pwsh
        run: |
          Write-Host "Step 1: Add Conda to system PATH"
          $env:Path = "$env:USERPROFILE\Miniconda3;$env:USERPROFILE\Miniconda3\Scripts;$env:Path"
          [System.Environment]::SetEnvironmentVariable("Path", $env:Path, [System.EnvironmentVariableTarget]::Machine)

          Write-Host "Step 2: Initialize conda for both shells"
          & "$env:USERPROFILE\Miniconda3\Scripts\conda.exe" init powershell
          & "$env:USERPROFILE\Miniconda3\Scripts\conda.exe" init cmd.exe

          Write-Host "Step 3: Create the environment at system level"
          & "$env:USERPROFILE\Miniconda3\Scripts\conda.exe" create -n gaiaenv python=3.10 -y

      - name: Install dependencies
        shell: pwsh
        run: |
          Write-Host "Step 1: Activate conda environment"
          & "$env:USERPROFILE\Miniconda3\shell\condabin\conda-hook.ps1"
          conda activate gaiaenv

          Write-Host "Step 2: Install dependencies"
          python -m pip install --upgrade pip
          conda install pylint -y
          pip install -e .[dev]

          Write-Host "Step 3: Verify installation"
          $gaiaPath = Get-Command gaia -ErrorAction SilentlyContinue
          if (-not $gaiaPath) {
            Write-Host "Error: gaia not installed correctly"
            Write-Host "Current PATH: $env:Path"
            exit 1
          }
          Write-Host "Found gaia at: $($gaiaPath.Source)"
          python -m pip check

      - name: Install Ollama
        shell: cmd
        run: |
          curl -L https://ollama.com/download/OllamaSetup.exe -o OllamaSetup.exe --progress-bar
          echo Ollama download complete. Starting installation.
          start /wait OllamaSetup.exe /VERYSILENT /SUPPRESSMSGBOXES /SP- /LOG="llama_install.log"
          echo "Ollama installation log:"
          type llama_install.log
          echo "PATH=C:\Users\runneradmin\AppData\Local\Programs\Ollama;%PATH%" >> $GITHUB_ENV
          del OllamaSetup.exe

      - name: Verify Ollama Installation
        shell: cmd
        run: |
          if exist "C:\Users\runneradmin\AppData\Local\Programs\Ollama\ollama.exe" (
              echo "Ollama installed successfully."
          ) else (
              echo "Ollama installation failed. Executable not found."
              exit 1
          )
          set PATH=%PATH%;C:\Users\runneradmin\AppData\Local\Programs\Ollama
          ollama --version

      - name: Ensure GAIA can open properly
        shell: pwsh
        env:
          HUGGINGFACE_ACCESS_TOKEN: ${{ secrets.HUGGINGFACE_ACCESS_TOKEN }}
          HF_TOKEN: ${{ secrets.HUGGINGFACE_ACCESS_TOKEN }}
        run: |
          Write-Host "Step 1: Activate and verify Conda environment"
          $env:Path = "$env:USERPROFILE\Miniconda3;$env:USERPROFILE\Miniconda3\Scripts;$env:Path"
          & "$env:USERPROFILE\Miniconda3\shell\condabin\conda-hook.ps1"
          conda activate gaiaenv

          Write-Host "Verify Python environment"
          python -c "import sys; print(sys.executable)"

          Write-Host "Find gaia executable location"
          $gaiaPath = Get-Command gaia -ErrorAction SilentlyContinue
          if (-not $gaiaPath) {
            Write-Host "Error: Cannot find gaia executable in PATH"
            Write-Host "Current PATH: $env:Path"
            exit 1
          }
          Write-Host "Found gaia at: $($gaiaPath.Source)"

          Write-Host "Step 2: Ensure that nothing is running on ports 8000 and 8001"
          $portCheck = Test-NetConnection -ComputerName 127.0.0.1 -Port 8001
          if ($portCheck.TcpTestSucceeded) {
            Write-Host "Error: Port 8001 (agent) is already in use!"
            exit 1
          } else {
            Write-Host "Port 8001 (agent) is free."
          }

          $portCheck = Test-NetConnection -ComputerName 127.0.0.1 -Port 8000
          if ($portCheck.TcpTestSucceeded) {
            Write-Host "Error: Port 8000 (llm server) is already in use!"
            exit 1
          } else {
            Write-Host "Port 8000 (llm server) is free."
          }

          Write-Host "Step 3: Start GAIA in the background"
          $env:QT_QPA_PLATFORM = "offscreen"
          Write-Host "Environment variable QT_QPA_PLATFORM set to offscreen"
          $gaiaOutput = "gaia_output.log"
          $gaiaErrorOutput = "gaia_error.log"
          $env:PATH = "$env:PATH;C:\Users\runneradmin\AppData\Local\Programs\Ollama"
          $gaiaProcess = Start-Process -NoNewWindow -FilePath "gaia" -RedirectStandardOutput $gaiaOutput -RedirectStandardError $gaiaErrorOutput -PassThru
          Write-Host "Started GAIA..."

          Write-Host "Step 4: Wait for 360 seconds for GAIA to initialize"
          Start-Sleep -Seconds 180
          Write-Host "Waited for 180 seconds."
          Write-Host "GAIA Output:"
          Get-Content $gaiaOutput
          Get-Content $gaiaErrorOutput

          Write-Host "Step 5: Check if GAIA is still running"
          $gaiaRunning = Get-Process -Id $gaiaProcess.Id -ErrorAction SilentlyContinue
          if (-not $gaiaRunning) {
            Write-Host "Error: GAIA process exited unexpectedly!"
            exit 1
          } else {
            Write-Host "GAIA process is still alive."
          }

          Write-Host "Step 6: Check if GAIA servers are running"
          $portCheck = Test-NetConnection -ComputerName 127.0.0.1 -Port 8001
          if (-not $portCheck.TcpTestSucceeded) {
            Write-Host "Error: Agent server is not running on port 8001!"
            exit 1
          } else {
            Write-Host "Agent server is running on port 8001."
          }

          $portCheck = Test-NetConnection -ComputerName 127.0.0.1 -Port 8000
          if (-not $portCheck.TcpTestSucceeded) {
            Write-Host "Error: LLM server is not running on port 8000!"
            exit 1
          } else {
            Write-Host "LLM server is running on port 8000."
          }


          Write-Host "Step 9: Stop the GAIA process"
          Stop-Process -Id $gaiaProcess.Id
          Write-Host "GAIA process has been stopped."
