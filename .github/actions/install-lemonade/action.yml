# Copyright(C) 2024-2025 Advanced Micro Devices, Inc. All rights reserved.
# SPDX-License-Identifier: MIT

name: 'Install Lemonade Server'
description: 'Downloads and installs Lemonade Server with hybrid extras'

runs:
  using: 'composite'
  steps:
    - name: Get Lemonade Version
      shell: powershell
      run: |
        $lemonadeVersion = python -c "import sys; sys.path.append('src'); from gaia.version import LEMONADE_VERSION; print(LEMONADE_VERSION)"
        echo "LEMONADE_VERSION=$lemonadeVersion" >> $env:GITHUB_ENV
        Write-Host "Using Lemonade version: $lemonadeVersion"

    - name: Install Lemonade Server
      shell: powershell
      run: |
        Write-Host "=== Installing Lemonade Server ==="

        # Add exclusions for the installer and install directory
        Add-MpPreference -ExclusionPath "C:\temp\Lemonade_Server_Installer.exe"
        Add-MpPreference -ExclusionPath "$env:LOCALAPPDATA\lemonade_server"
        Add-MpPreference -ExclusionProcess "Lemonade_Server_Installer.exe"

        # Download and run installer
        $installerPath = "C:\temp\Lemonade_Server_Installer.exe"
        
        # Remove existing file if it exists
        if (Test-Path $installerPath) {
          Write-Host "Removing existing installer file"
          Remove-Item $installerPath -Force
        }
        
        Invoke-WebRequest -Uri "https://github.com/lemonade-sdk/lemonade/releases/download/v$env:LEMONADE_VERSION/Lemonade_Server_Installer.exe" -OutFile $installerPath -UseBasicParsing
        
        # Check downloaded file
        if (Test-Path $installerPath) {
          $fileInfo = Get-Item $installerPath
          Write-Host "Downloaded installer: $($fileInfo.Length) bytes"
          
          # Basic sanity check - installer should be at least 100KB
          if ($fileInfo.Length -lt 100000) {
            Write-Host "ERROR: Downloaded file is suspiciously small ($($fileInfo.Length) bytes)"
            Write-Host "This suggests we downloaded an error page instead of the installer"
            
            # Check if we got HTML error page (without -Raw and -TotalCount together)
            $firstBytes = Get-Content $installerPath -Encoding Byte -TotalCount 200
            $firstText = [System.Text.Encoding]::ASCII.GetString($firstBytes)
            Write-Host "First 200 characters of downloaded file:"
            Write-Host $firstText
            exit 1
          }
        } else {
          Write-Host "ERROR: Installer file not found after download"
          exit 1
        }

    - name: Run Lemonade Installer
      shell: powershell
      run: |
        Write-Host "Installing Lemonade Server..."
        cd C:\temp
        Start-Process -FilePath ".\Lemonade_Server_Installer.exe" -ArgumentList "/S /Extras=hybrid /Models=Llama-3.2-3B-Instruct-Hybrid /D=C:\Users\nimbys\AppData\Local\lemonade_server" -Wait
        Write-Host "Installer completed"

    - name: Verify Installation
      shell: powershell  
      run: |
        $installPath = "C:\Users\nimbys\AppData\Local\lemonade_server"
        
        # Remove exclusions after installation
        Remove-MpPreference -ExclusionPath "C:\temp\Lemonade_Server_Installer.exe"
        Remove-MpPreference -ExclusionProcess "Lemonade_Server_Installer.exe"

        # Basic verification
        if (-not (Test-Path $installPath)) {
            Write-Host "Installation directory not found"
            exit 1
        }

        # Test lemonade-server command
        $lemonadeExe = "$installPath\python\Scripts\lemonade-server-dev.exe"
        if (Test-Path $lemonadeExe) {
            & $lemonadeExe --version
            Write-Host "Lemonade Server installed successfully"
        } else {
            Write-Host "Lemonade server executable not found at: $lemonadeExe"
            if (Test-Path "$installPath\python\Scripts") {
                Write-Host "Scripts directory contents:"
                Get-ChildItem "$installPath\python\Scripts" | ForEach-Object { Write-Host "  - $($_.Name)" }
            }
            exit 1
        }